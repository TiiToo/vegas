/*

  The contents of this file are subject to the Mozilla Public License Version
  1.1 (the "License"); you may not use this file except in compliance with
  the License. You may obtain a copy of the License at 
  
           http://www.mozilla.org/MPL/ 
  
  Software distributed under the License is distributed on an "AS IS" basis,
  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
  for the specific language governing rights and limitations under the License. 
  
  The Original Code is Vegas Framework.
  
  The Initial Developer of the Original Code is
  ALCARAZ Marc (aka eKameleon)  <vegas@ekameleon.net>.
  Portions created by the Initial Developer are Copyright (C) 2004-2005
  the Initial Developer. All Rights Reserved.
  
  Contributor(s) :
  
*/

/** Log

	AUTHOR

		Name : Log
		type : SSAS
		Package : vegas.logging
		Version : 1.0.0.0
		Author : ekameleon
		Date : 2006-05-31
		URL : http://www.ekameleon.net
		Mail : vegas@ekameleon.net
		
	CONSTANT SUMMARY
	
		- DEFAULT_CATEGORY : ""
		
		- ILLEGALCHARACTERS : "[]~$^&\/(){}<>+=`!#%?,:;'\"@"

	METHOD SUMMARY
	
		- static addTarget(target:ITarget, [logger:ILogger] ):Void
		
			DESCRIPTION
			
				Allows the specified target to begin receiving notification of log events.
			
			PARAMS
			
				- target : an ITarget instance
				
				- logger : optional ILogger instance
		
		- static flush():Void
		
			This method will remove all of the current loggers from the cache.
		
		- static getLogger(category:String, isQueue:Boolean) : ILogger 
		
			Returns the logger associated with the specified category.
			If the category given doesn't exist a new instance of a logger will be returned and associated with that category.
			Categories must be at least one character in length and may not contain any blanks or any of the following characters :
				[]~$^&\/(){}<>+=`!#%?,:;'"@ 
			This method will throw an InvalidCategoryError if the category specified is malformed.
		
		- static hasIllegalCharacters(value:String) : Boolean 
		
			This method checks the specified string value for illegal characters.
			
			Parameters
				
				value:String : string to check for illegal characters. The following characters are not valid: []~$^&\/(){}<>+=`!#%?,:;'"@
			
			Returns
			
				Boolean : true if there are any illegal characters found, false otherwise
		
		- static removeTarget(target:ITarget, [logger:ILogger] ) : Void 
			
			Stops the specified target from receiving notification of log events.
	
	
**/ 



if (vegas.logging._Log == undefined) {

	// ----o Imports
	
	load(PATH + "vegas/logging/LogLogger.asc") ;

	// ----o Private Singleton

	vegas.logging._Log = function () {
		
		this.logger = new vegas.logging.LogLogger() ;
		
		this.categories = new vegas.data.map.HashMap() ;
		
	}
	
	// ----o Inherit
	
	vegas.logging._Log.extend(vegas.core.CoreObject) ;

	// ----o Public Methods
	
	vegas.logging._Log.prototype.logger = null ;
	vegas.logging._Log.prototype.categories = null ;

	// ----o Constants
	
	vegas.logging._Log.DEFAULT_CATEGORY  = "" ;
	
	vegas.logging._Log.ILLEGALCHARACTERS = "[]~$^&/\\(){}<>+=`!#%?,:;'\"@" ;



	// ----o Public Methods
		
	vegas.logging._Log.prototype.addTarget = function (target, logger) {
		
		if ( target instanceof vegas.logging.ITarget ) {
			
			var lg ;
			
			if (logger instanceof vegas.logging.ILogger) {
				
				lg = logger ;
				
			} else {
				
				lg = this.logger ;
				
			}
			
			target.addLogger( lg ) ;
			
		}
	}
	
	vegas.logging._Log.prototype.flush = function () {
		
		this.categories.clear() ;
		
	}

	vegas.logging._Log.getInstance = function ()  {
		if (vegas.logging._Log.__INSTANCE__ = null) {
			vegas.logging._Log.__INSTANCE__ = new vegas.logging._Log() ;
		}
		return vegas.logging._Log.__INSTANCE__ ;
	}
	
	vegas.logging._Log.prototype.getLogger = function (category , isQueue) {
		
		if (category == null) {
			category = vegas.logging._Log.DEFAULT_CATEGORY ;
		}
	
		if ( this.hasIllegalCharacters(category) ) {
		
			throw new vegas.logging.errors.InvalidCategoryError("Log 'getLogger', category is invalid.") ;
			
		}
		
		if (! this.categories.containsKey(category) ) {
			
			var logger = new vegas.logging.LogLogger(category) ;
			
			
			logger.isQueue = isQueue || false ;
			logger.addEventListener( vegas.logging.LogEvent.LOG, new vegas.events.Delegate(this, this._handleEvent) ) ;
			logger.parent = this.logger ; // Bubbling Event
			
			this.categories.put(category, logger) ;
			
		}
		
		return this.categories.get(category) ;
	}
		
	vegas.logging._Log.prototype.hasIllegalCharacters = function ( value )  {
		
		if (value == null) return false ;
		
		var a  = vegas.logging._Log.ILLEGALCHARACTERS.split("") ;
		
		return value.indexOfAny( a ) != -1 ;
		
	}
	
	vegas.logging._Log.prototype.removeTarget = function (target , logger)  {
		
		target.removeLogger( logger || this.logger ) ;
		
	}
	
	vegas.logging._Log.prototype.toString = function() {
		return "[Log]" ;
	}
	
	vegas.logging._Log.prototype._handleEvent = function (e) {
		this.logger.dispatchEvent(e) ;
	}
	
	// ----o Encapsulate

	//trace ("***** running vegas.logging._Log") ;

	vegas.logging.Log = new vegas.logging._Log() ;

}